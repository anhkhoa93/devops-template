name: CI/CD Pipeline for Node.js Application with Docker and Playwright

on:
  push:
    branches:
      - develop  # Trigger on push to the develop branch
  pull_request:
    branches:
      - develop  # Trigger on pull requests to the develop branch
  workflow_dispatch:  # Allows manual triggering and environment selection
    inputs:
      environment:
        description: 'Select the environment'
        required: true
        type: choice
        options:
          - dev
          - staging

env:
  DOCKER_IMAGE: my-app
  DOCKER_TAG: ${{ github.sha }}  # Tag Docker image with Git commit SHA
  REGISTRY: ghcr.io  # GitHub Container Registry (can use DockerHub or AWS ECR)
  NODE_ENV: dev  # Set default environment

jobs:
  # Job to build and test the application
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG .

      # Run Playwright tests in Docker container
      - name: Run Playwright tests
        run: |
          docker run --rm $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG npm test  # Replace with your test command
     # Save Docker image as artifact for different environments
      - name: Save Docker image as artifact for dev, staging, and prod
        uses: actions/upload-artifact@v2
        with:
          name: $DOCKER_IMAGE-$DOCKER_TAG
          path: ./docker-image.tar

  # Job to deploy the application
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test  # Deploy job runs only after build-and-test succeeds
    if: github.event.pull_request.review.state == 'approved' || github.ref == 'refs/heads/develop'  # Only deploy to prod when PR is approved or directly merged to develop

    environment:
      name: ${{ github.event.inputs.environment }}  # Use environment input for dev/staging/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # Download artifact (Docker image)
      - name: Download Docker image artifact
        uses: actions/download-artifact@v2
        with:
          name: $DOCKER_IMAGE-${{ github.sha }}

      # SSH to EC2 and deploy the image
      - name: SSH to EC2 and deploy Docker image
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}  # EC2 instance public IP
          username: ${{ secrets.EC2_USER }}  # EC2 instance SSH username (e.g., ec2-user for Amazon Linux)
          key: ${{ secrets.EC2_PRIVATE_KEY }}  # EC2 private SSH key
          port: 22  # Default SSH port
          script: |
            # Pull the Docker image from the registry
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} $REGISTRY
            docker pull $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG

            # Run the Docker container (you may want to stop the running container first)
            docker ps -q --filter "name=$DOCKER_IMAGE" | grep -q . && docker stop $DOCKER_IMAGE && docker rm $DOCKER_IMAGE
            docker run -d --name $DOCKER_IMAGE -p 80:80 $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG